version: '3'

services:
  traefik:
    image: traefik:v2.5
      # Enables the web UI and tells Traefik to listen to docker
    command: --api.insecure=true --providers.docker
    ports:
        # The HTTP port
        - "80:80"
        # The Web UI (enabled by --api.insecure=true)
        - "8080:8080"
    volumes:
        # So that Traefik can listen to the Docker events
        - /var/run/docker.sock:/var/run/docker.sock


  mysql_master:
    image: mysql:8.0
    env_file:
      - ./master/mysql_master.env
    container_name: "mysql_master"
    restart: "no"
    ports:
      - 3306:3306
    volumes:
      - ./master/conf/mysql.conf.cnf:/etc/mysql/conf.d/mysql.conf.cnf
      - ./master/data:/var/lib/mysql
    networks:
      - traefik
      - overlay
    depends_on:
      - traefik
    labels:
      - "traefik.http.routers.mysql_master.rule=Host(`mysql-master.example.com`)"


  flaskapp_master:
    build:
      context: ./master
    container_name: "flaskapp_master"
    restart: "no"
    ports:
      - "5000"
    labels:
      - "traefik.http.routers.flaskapp_master.rule=Host(`flaskapp-master.example.com`)"
      - "traefik.http.services.flaskapp_master.loadbalancer.server.port=5000"

    networks:
      - traefik
      - overlay
    depends_on:
      - traefik
      - mysql_master


networks:
  traefik:
    external: true
  overlay:
